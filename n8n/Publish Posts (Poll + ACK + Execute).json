{
  "nodes": [
    {
      "parameters": {
        "content": "# ðŸš¨Add the CloudFlare API token, read this carefully\n\n### Add the workers AI authentication template\n### Then edit the token, and add the `Accounts -> Account Settings (Read)` permission and save it",
        "height": 416,
        "width": 448
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -96,
        -704
      ],
      "id": "558e0af3-bcbc-4cb4-b626-3058f4196d31",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3f7d5020-0710-4f3c-858f-0485a2bd2963",
              "name": "width",
              "value": "=1024",
              "type": "number"
            },
            {
              "id": "39b906fa-3e0b-45b9-9c1b-95cbc51e195d",
              "name": "prompt",
              "value": "={{ $('Webhook').item.json.body.imagePrompt }}",
              "type": "string"
            },
            {
              "id": "3f8593d2-cfb3-437a-a9fc-4430995cb78f",
              "name": "height",
              "value": "=768",
              "type": "number"
            },
            {
              "id": "065181ef-404a-4860-9019-976e6e8391e0",
              "name": "seed",
              "value": "={{ Math.floor(Math.random() * 100000000) }}",
              "type": "number"
            },
            {
              "id": "2c131da3-e708-4468-bb09-d400e7e5f28c",
              "name": "steps",
              "value": 4,
              "type": "number"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -768,
        -512
      ],
      "id": "2e2a5aad-b6f4-472e-a78e-52505a8fd9cf",
      "name": "Setup workflow"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f6e30a82-76cd-4bfd-9bc5-b7fffb15e35c",
              "leftValue": "={{ $json.width * $json.height > 1048576 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -464,
        -464
      ],
      "id": "84751949-9333-448e-b9c2-b72a91bbb631",
      "name": "Check image size"
    },
    {
      "parameters": {
        "errorMessage": "The size of the image (width x height) is larger than 1 megapixel"
      },
      "type": "n8n-nodes-base.stopAndError",
      "typeVersion": 1,
      "position": [
        -272,
        -640
      ],
      "id": "22e40dc2-7d1d-455a-9ac6-c9cfbe0d9bb2",
      "name": "Image > 1 megapixel"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.cloudflare.com/client/v4/accounts/{{ $json.result[0].id }}/ai/run/@cf/black-forest-labs/flux-1-schnell",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendBody": true,
        "specifyBody": "=json",
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "jsonBody": "={{ \n\nJSON.stringify(\n  {\n    prompt: $('Setup workflow').item.json.prompt,\n    seed: $('Setup workflow').item.json.seed,\n    \"width\": $('Setup workflow').item.json.width,\n    \"height\": $('Setup workflow').item.json.height,\n    \"steps\": $('Setup workflow').item.json.steps\n  }\n) \n\n}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        160,
        -416
      ],
      "id": "7b82f4b6-b3b4-4701-8066-304275d34ad5",
      "name": "Get Flux Schnell image",
      "credentials": {
        "httpBearerAuth": {
          "id": "EldIXMOPmzpNQf1L",
          "name": "Cloudflare"
        }
      }
    },
    {
      "parameters": {
        "url": "https://api.cloudflare.com/client/v4/accounts",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -48,
        -416
      ],
      "id": "819810e8-7216-4e4f-b414-06202dd9dc7b",
      "name": "Get accounts",
      "credentials": {
        "httpBearerAuth": {
          "id": "EldIXMOPmzpNQf1L",
          "name": "Cloudflare"
        }
      }
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "result.image",
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        464,
        -448
      ],
      "id": "2848e5a3-f244-40e5-9098-40e2f59e5f41",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "jsCode": "// 1) Echo láº¡i input tá»« FE (Ä‘i qua Webhook)\nconst root = $json;\nconst bodyRaw = root.body;\nlet recv = {};\nif (bodyRaw && typeof bodyRaw === 'string') {\n  try { recv = JSON.parse(bodyRaw) } catch { recv = {} }\n} else if (bodyRaw && typeof bodyRaw === 'object') {\n  recv = bodyRaw;\n} else {\n  recv = root || {};\n}\n\nconst meta = {\n  platform:$('Webhook').first().json.body.platform ,\n  tone:$('Webhook').first().json.body.tone,\n  length: $('Webhook').first().json.body.length,\n  imagePrompt:$('Webhook').first().json.body.imagePrompt\n};\n\n// 2) Láº¥y output tá»« AI Agent (Ä‘a nhÃ  cung cáº¥p)\nlet aiRaw =\n  root.text ??\n  root.output ??\n  root.message ??\n  root.data ??\n  root.content_text ??\n  root.draft ??\n  '';\n\n// Helper\nconst looksLikeJson = (s) => typeof s === 'string' && /^[\\[{]/.test(s.trim());\nconst toSingleSpaces = (s) => s.replace(/\\s+\\n/g, '\\n').replace(/[ \\t]+/g, ' ');\nconst unescapeNewlines = (s) => s.replace(/\\\\n/g, '\\n');\nconst normalizeText = (s) => toSingleSpaces(unescapeNewlines(String(s || '')).replace(/\\r\\n/g, '\\n')).trim();\n\n// 3) Chuáº©n hoÃ¡ thÃ nh object thá»‘ng nháº¥t\nlet contentText = '';\nlet hashtagsArr = [];\n\n// TÃ¡ch hashtag tá»« string (giá»¯ thá»© tá»± xuáº¥t hiá»‡n, unique, lowercase)\nfunction extractHashtags(str) {\n  const found = [];\n  const set = new Set();\n  const re = /(^|[\\s.,;!?:()\\[\\]{}\"'])#([a-z0-9_]+)/gi;\n  let m;\n  while ((m = re.exec(str))) {\n    const tag = '#' + m[2].toLowerCase();\n    if (!set.has(tag)) {\n      set.add(tag);\n      found.push(tag);\n    }\n  }\n  return found;\n}\n\ntry {\n  if (typeof aiRaw === 'object' && aiRaw !== null) {\n    // TH: AI tráº£ vá» object/array á»Ÿ $json\n    const pick = Array.isArray(aiRaw) ? aiRaw[0] : aiRaw;\n\n    if (pick && pick.content_text) {\n      contentText = normalizeText(pick.content_text);\n      if (Array.isArray(pick.hashtags)) hashtagsArr = pick.hashtags.map(h => h.toLowerCase());\n      if (!hashtagsArr.length) hashtagsArr = extractHashtags(contentText);\n    } else if (pick && (pick.Caption || pick.Idea || pick.Environment || pick.Sound)) {\n      // TH: JSON theo máº«u Idea/Caption/Environment/Sound\n      const caption = (pick.Caption || '').trim();\n      const idea = (pick.Idea || '').trim();\n      const env = (pick.Environment || '').trim();\n      const sound = (pick.Sound || '').trim();\n      const status = (pick.Status || '').trim();\n\n      const body = [\n        caption && `Caption: ${caption}`,\n        idea && `Ã tÆ°á»Ÿng: ${idea}`,\n        env && `MÃ´i trÆ°á»ng: ${env}`,\n        sound && `Ã‚m thanh: ${sound}`,\n        status && `Tráº¡ng thÃ¡i: ${status}`,\n      ].filter(Boolean).join('\\n\\n');\n\n      contentText = normalizeText(body);\n      // Æ¯u tiÃªn hashtag ngay trong Caption náº¿u cÃ³\n      hashtagsArr = extractHashtags(caption);\n      if (!hashtagsArr.length && pick.hashtags) {\n        hashtagsArr = Array.isArray(pick.hashtags)\n          ? pick.hashtags.map(h => h.toLowerCase())\n          : extractHashtags(String(pick.hashtags));\n      }\n      if (!hashtagsArr.length) hashtagsArr = extractHashtags(contentText);\n    } else if (pick && (pick.draft || pick.hashtags)) {\n      // TH: báº¡n Ä‘ang cÃ³ hiá»‡n táº¡i\n      const draft = normalizeText(pick.draft || '');\n      const tags = Array.isArray(pick.hashtags) ? pick.hashtags.join(' ') : (pick.hashtags || '');\n      const tagsNorm = normalizeText(tags);\n      contentText = draft;\n      hashtagsArr = extractHashtags(tagsNorm);\n      if (!hashtagsArr.length) hashtagsArr = extractHashtags(contentText);\n    } else {\n      // Fallback: stringify object\n      contentText = normalizeText(JSON.stringify(pick));\n      hashtagsArr = extractHashtags(contentText);\n    }\n  } else if (looksLikeJson(aiRaw)) {\n    // TH: string nhÆ°ng lÃ  JSON (array hoáº·c object)\n    const parsed = JSON.parse(aiRaw);\n    const pick = Array.isArray(parsed) ? parsed[0] : parsed;\n\n    if (pick && pick.content_text) {\n      contentText = normalizeText(pick.content_text);\n      hashtagsArr = Array.isArray(pick.hashtags) ? pick.hashtags.map(h => h.toLowerCase()) : extractHashtags(contentText);\n    } else if (pick && (pick.Caption || pick.Idea || pick.Environment || pick.Sound)) {\n      const caption = (pick.Caption || '').trim();\n      const idea = (pick.Idea || '').trim();\n      const env = (pick.Environment || '').trim();\n      const sound = (pick.Sound || '').trim();\n      const status = (pick.Status || '').trim();\n\n      const body = [\n        caption && `Caption: ${caption}`,\n        idea && `Ã tÆ°á»Ÿng: ${idea}`,\n        env && `MÃ´i trÆ°á»ng: ${env}`,\n        sound && `Ã‚m thanh: ${sound}`,\n        status && `Tráº¡ng thÃ¡i: ${status}`,\n      ].filter(Boolean).join('\\n\\n');\n\n      contentText = normalizeText(body);\n      hashtagsArr = extractHashtags(caption);\n      if (!hashtagsArr.length && pick.hashtags) {\n        hashtagsArr = Array.isArray(pick.hashtags)\n          ? pick.hashtags.map(h => h.toLowerCase())\n          : extractHashtags(String(pick.hashtags));\n      }\n      if (!hashtagsArr.length) hashtagsArr = extractHashtags(contentText);\n    } else if (pick && (pick.draft || pick.hashtags)) {\n      const draft = normalizeText(pick.draft || '');\n      const tags = Array.isArray(pick.hashtags) ? pick.hashtags.join(' ') : (pick.hashtags || '');\n      contentText = draft;\n      hashtagsArr = extractHashtags(tags);\n      if (!hashtagsArr.length) hashtagsArr = extractHashtags(contentText);\n    } else {\n      contentText = normalizeText(JSON.stringify(pick));\n      hashtagsArr = extractHashtags(contentText);\n    }\n  } else {\n    // TH: string thuáº§n\n    const s = normalizeText(aiRaw);\n    // Cáº¯t thÃ¢n bÃ i vÃ  dÃ²ng hashtag náº¿u cÃ³\n    const lines = s.split('\\n');\n    const bodyLines = [];\n    const hashLines = [];\n    for (const line of lines) {\n      const t = line.trim();\n      if (t.startsWith('#') || t.includes(' #')) hashLines.push(t);\n      else bodyLines.push(line);\n    }\n    contentText = bodyLines.join('\\n').trim();\n    hashtagsArr = extractHashtags(hashLines.join(' '));\n    if (!hashtagsArr.length) hashtagsArr = extractHashtags(contentText);\n  }\n} catch (e) {\n  // Fallback an toÃ n\n  const s = normalizeText(aiRaw);\n  contentText = s;\n  hashtagsArr = extractHashtags(s);\n}\n\n// 4) Giá»›i háº¡n & format hashtag: unique, lowercase, tá»‘i Ä‘a 12\nconst unique = [];\nconst seen = new Set();\nfor (const h of hashtagsArr) {\n  const tag = h.toLowerCase();\n  if (!seen.has(tag)) {\n    seen.add(tag);\n    unique.push(tag);\n  }\n}\nhashtagsArr = unique.slice(0, 12);\n\n// GhÃ©p bÃ i + hashtags (Ä‘á»ƒ FE hiá»ƒn thá»‹ ngay)\nconst hashtagsStr = hashtagsArr.join(' ');\nconst finalText = hashtagsArr.length ? `${contentText}\\n\\n${hashtagsStr}` : contentText;\n\n// 6) Media tá»« FE\nconst media = Array.isArray(recv.media) ? recv.media.filter(u => /^https?:/i.test(String(u))) : [];\n\n// 7) Tráº£ vá» format thá»‘ng nháº¥t cho FE\nconst basePayload = {\n  success: true,\n  received: {\n    prompt: $('Webhook').first().json.body.prompt,\n    tone: meta.tone,\n    length: meta.length,\n    platform: meta.platform,\n    autoGenerateImage: $('Webhook').first().json.body.autoGenerateImage,\n    imagePrompt: meta.imagePrompt,\n  },\n  data: {\n    content_text: finalText,\n    hashtags: hashtagsArr,\n    platform: meta.platform,\n    tone: meta.tone,\n    length: meta.length,\n    generatedAt: new Date().toISOString(),\n    media,\n  }\n};\n\nreturn [{ json: { ...basePayload, normalized: basePayload } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1456,
        112
      ],
      "id": "ba7da6a0-7cd2-4111-9f3c-e64940deaab1",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "abf1c158-b7b3-4f95-9efe-bc54f457cabd",
      "name": "Respond ",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1520,
        64
      ]
    },
    {
      "parameters": {
        "jsCode": "// Láº¥y full item (cÃ³ cáº£ json vÃ  binary)\nconst item = $input.first();\nconst currentJson = item.json || {};\n\n// Láº¥y payload text Ä‘Ã£ normalize tá»« node trÆ°á»›c\nconst baseNode = $node['Code in JavaScript1'].json || {};\nconst normalized = baseNode.normalized || baseNode;\n\nlet imageUrl = null;\n\n// Náº¿u item cÃ³ binary tá»« Convert to File thÃ¬ táº¡o data URL cho FE preview\nif (item.binary && item.binary.data) {\n  const bin = item.binary.data;\n  const mime = bin.mimeType || 'image/jpeg';\n  const b64 = bin.data;\n  if (typeof b64 === 'string' && b64.length > 0) {\n    imageUrl = `data:${mime};base64,${b64}`;\n  }\n}\n\n// CÃ¡c Ä‘Æ°á»ng khÃ¡c: náº¿u upstream Ä‘Ã£ cÃ³ url/base64 trong JSON\nif (!imageUrl && typeof currentJson.imageUrl === 'string') imageUrl = currentJson.imageUrl;\n\nif (!imageUrl && currentJson.predictions && Array.isArray(currentJson.predictions)) {\n  const p = currentJson.predictions[0] || {};\n  if (typeof p.imageUri === 'string' && p.imageUri.startsWith('http')) imageUrl = p.imageUri;\n  if (!imageUrl && typeof p.bytesBase64Encoded === 'string') {\n    imageUrl = 'data:image/png;base64,' + p.bytesBase64Encoded;\n  }\n}\n\nif (!imageUrl && currentJson.data) {\n  const d = currentJson.data;\n  if (Array.isArray(d) && d[0]) {\n    if (typeof d[0].url === 'string') imageUrl = d[0].url;\n    if (!imageUrl && typeof d[0].b64_json === 'string') {\n      imageUrl = 'data:image/png;base64,' + d[0].b64_json;\n    }\n  }\n  if (!imageUrl && d.images && Array.isArray(d.images) && d.images[0]) {\n    if (typeof d.images[0].url === 'string') imageUrl = d.images[0].url;\n    if (!imageUrl && typeof d.images[0].b64_json === 'string') {\n      imageUrl = 'data:image/png;base64,' + d.images[0].b64_json;\n    }\n  }\n}\n\nif (!imageUrl && currentJson.candidates && Array.isArray(currentJson.candidates)) {\n  const c = currentJson.candidates[0];\n  const part = c && c.content && Array.isArray(c.content.parts) ? c.content.parts[0] : null;\n  if (part && part.inlineData && typeof part.inlineData.data === 'string') {\n    imageUrl = 'data:image/png;base64,' + part.inlineData.data;\n  }\n}\n\nconst media = Array.isArray(normalized.data?.media) ? normalized.data.media.slice() : [];\nif (imageUrl) media.push(imageUrl);\n\nconst out = {\n  ...normalized,\n  data: {\n    ...normalized.data,\n    media,\n  },\n};\n\nreturn [{ json: out }];\n"
      },
      "id": "f0aca451-76a7-4ced-ab45-842adf4939f4",
      "name": "Finalize Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1088,
        -272
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$node[\"Webhook\"].json[\"body\"][\"autoGenerateImage\"] && !!$node[\"Webhook\"].json[\"body\"][\"imagePrompt\"]}}",
              "value2": true
            }
          ]
        }
      },
      "id": "a6f66ae8-7f24-4290-9686-1528415af0b5",
      "name": "IF Generate Image",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1200,
        112
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -2144,
        336
      ],
      "id": "68fe2c53-7664-4479-af98-d5f00732b15d",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "d8JXN8kohL0dLa37",
          "name": "n8ntest"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        -1760,
        400
      ],
      "id": "68c021b4-4632-4e9a-aafd-aee0fd5a8d2f",
      "name": "Think"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{$json[\"body\"][\"prompt\"]}} \n- Viáº¿t má»™t bÃ i {{$json[\"body\"][\"length\"]}} \nbáº±ng giá»ng vÄƒn {{$json[\"body\"][\"tone\"]}} \ncho ná»n táº£ng {{$json[\"body\"][\"platform\"]}}.\n\nYÃªu cáº§u:\n- Viáº¿t ná»™i dung hoÃ n chá»‰nh, thu hÃºt, dá»… Ä‘á»c trÃªn máº¡ng xÃ£ há»™i.\n- ThÃªm 3-5 hashtag tiáº¿ng Viá»‡t/phÃ¹ há»£p á»Ÿ cuá»‘i bÃ i.\n- KhÃ´ng há»i láº¡i ngÆ°á»i dÃ¹ng, khÃ´ng yÃªu cáº§u thÃªm thÃ´ng tin, chá»‰ xuáº¥t ra ná»™i dung hoÃ n chá»‰nh.\n",
        "options": {
          "systemMessage": "You are a creative marketing assistant.\nGenerate engaging, platform-optimized content based on user's input.\nKeep tone consistent and suitable for branding.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -1904,
        112
      ],
      "id": "119e83c6-6feb-4ad8-a7f5-98371ba866ca",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "create-content",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "fcaf9b9c-763f-4659-a6b0-d78eb817ba2f",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -2288,
        112
      ],
      "webhookId": "24a4dc7f-b5c1-4c4e-a440-e1d7076ee46c"
    }
  ],
  "connections": {
    "Setup workflow": {
      "main": [
        [
          {
            "node": "Check image size",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check image size": {
      "main": [
        [
          {
            "node": "Image > 1 megapixel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get accounts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Flux Schnell image": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get accounts": {
      "main": [
        [
          {
            "node": "Get Flux Schnell image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Finalize Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "IF Generate Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finalize Payload": {
      "main": [
        [
          {
            "node": "Respond ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Generate Image": {
      "main": [
        [
          {
            "node": "Setup workflow",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Finalize Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "7435dce5e82963b5917f5dd085e640d9e48f3eee1559038e5ee2e732f7bb4630"
  }
}